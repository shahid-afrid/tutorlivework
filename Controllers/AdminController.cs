using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using TutorLiveMentor.Models;
using TutorLiveMentor.Services;
using TutorLiveMentor.Helpers;
using System.Linq;
using System.Text;
using Microsoft.AspNetCore.Antiforgery;
using OfficeOpenXml;

namespace TutorLiveMentor.Controllers
{
    public partial class AdminController : Controller
    {
        private readonly AppDbContext _context;
        private readonly SignalRService _signalRService;
        private readonly IAntiforgery _antiforgery;
        private readonly DynamicDbContextFactory _dbFactory;

        public AdminController(
            AppDbContext context, 
            SignalRService signalRService, 
            IAntiforgery antiforgery,
            DynamicDbContextFactory dbFactory)
        {
            _context = context;
            _signalRService = signalRService;
            _antiforgery = antiforgery;
            _dbFactory = dbFactory;
        }

        /// <summary>
        /// Helper method to check if department is CSE(DS) (handles specific variations only)
        /// This method is for in-memory use only, not for LINQ queries
        /// </summary>
        private bool IsCSEDSDepartment(string department)
        {
            if (string.IsNullOrEmpty(department)) return false;

            // Normalize the department string
            var normalizedDept = department.ToUpper().Replace("(", "").Replace(")", "").Replace(" ", "").Replace("-", "").Trim();

            // Match both CSE(DS) and legacy CSEDS format
            return normalizedDept == "CSEDS" || department.Equals("CSE(DS)", StringComparison.OrdinalIgnoreCase);
        }

        [HttpGet]
        public IActionResult Login()
        {
            return View();
        }

        [HttpPost]
        public async Task<IActionResult> Login(AdminLoginViewModel model)
        {
            if (!ModelState.IsValid)
                return View(model);

            try
            {
                // Find admin with matching credentials in database
                var admin = await _context.Admins
                    .FirstOrDefaultAsync(a => a.Email == model.Email && a.Password == model.Password);

                if (admin == null)
                {
                    ModelState.AddModelError("", "Invalid admin credentials!");
                    return View(model);
                }

                // Update last login time
                admin.LastLogin = DateTime.Now;
                await _context.SaveChangesAsync();

                // Clear any existing session
                HttpContext.Session.Clear();

                // Store admin information in session
                HttpContext.Session.SetInt32("AdminId", admin.AdminId);
                HttpContext.Session.SetString("AdminEmail", admin.Email);
                HttpContext.Session.SetString("AdminDepartment", admin.Department);

                // Force session to be saved immediately
                await HttpContext.Session.CommitAsync();

                // Notify system of admin login
                await _signalRService.NotifyUserActivity(admin.Email, "Admin", "Logged In", $"{admin.Department} department administrator logged into the system");

                // Redirect to department-specific dashboard based on department
                if (IsCSEDSDepartment(admin.Department))
                {
                    return RedirectToAction("CSEDSDashboard");
                }
                else
                {
                    // Redirect to Dynamic Dashboard for all other departments
                    return RedirectToAction("DynamicDashboard", new { department = admin.Department });
                }
            }
            catch (Exception ex)
            {
                ModelState.AddModelError("", $"Login error: {ex.Message}");
                return View(model);
            }
        }

        [HttpGet]
        public IActionResult MainDashboard()
        {
            var adminId = HttpContext.Session.GetInt32("AdminId");

            if (adminId == null)
            {
                TempData["ErrorMessage"] = "Please login to access the admin dashboard.";
                return RedirectToAction("Login");
            }

            ViewBag.AdminId = adminId;
            ViewBag.AdminEmail = HttpContext.Session.GetString("AdminEmail");
            ViewBag.AdminDepartment = HttpContext.Session.GetString("AdminDepartment");

            return View();
        }

        /// <summary>
        /// CSEDS Department-specific dashboard - NOW USING DYNAMIC TABLES
        /// Queries CSEDS-specific tables directly for better performance
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> CSEDSDashboard()
        {
            var adminId = HttpContext.Session.GetInt32("AdminId");
            var department = HttpContext.Session.GetString("AdminDepartment");

            // Debug logging
            Console.WriteLine($"CSEDSDashboard - AdminId: {adminId}, Department: {department}");

            if (adminId == null)
            {
                Console.WriteLine("Admin not logged in - redirecting to login");
                TempData["ErrorMessage"] = "Please login to access the admin dashboard.";
                return RedirectToAction("Login");
            }

            if (!IsCSEDSDepartment(department))
            {
                Console.WriteLine($"Access denied - Department: {department} is not CSE(DS)");
                TempData["ErrorMessage"] = "Access denied. CSE(DS) department access only.";
                return RedirectToAction("Login");
            }

            // Force session commit to ensure it persists
            await HttpContext.Session.CommitAsync();

            // ? NEW: Use CSEDS-specific tables via DynamicDbContextFactory
            using var csedsContext = _dbFactory.GetContext("CSEDS");
            
            var viewModel = new CSEDSDashboardViewModel
            {
                AdminEmail = HttpContext.Session.GetString("AdminEmail") ?? "",
                AdminDepartment = department ?? "",

                // Query CSEDS-specific tables directly (no filtering needed!)
                CSEDSStudentsCount = await csedsContext.Students.CountAsync(),
                CSEDSFacultyCount = await csedsContext.Faculties.CountAsync(),
                CSEDSSubjectsCount = await csedsContext.Subjects.CountAsync(),
                CSEDSEnrollmentsCount = await csedsContext.StudentEnrollments.CountAsync(),

                // Get recent CSEDS students (from Students_CSEDS table)
                RecentStudents = await csedsContext.Students
                    .OrderByDescending(s => s.Id)
                    .Take(5)
                    .Select(s => new StudentActivityDto
                    {
                        FullName = s.FullName,
                        Email = s.Email,
                        Department = s.Department,
                        Year = s.Year
                    })
                    .ToListAsync(),

                // Get recent CSEDS enrollments (from StudentEnrollments_CSEDS table)
                RecentEnrollments = await csedsContext.StudentEnrollments
                    .Include(se => se.Student)
                    .Include(se => se.AssignedSubject)
                        .ThenInclude(a => a.Subject)
                    .Include(se => se.AssignedSubject)
                        .ThenInclude(a => a.Faculty)
                    .OrderByDescending(se => se.EnrolledAt)
                    .Take(10)
                    .Select(se => new EnrollmentActivityDto
                    {
                        StudentName = se.Student.FullName,
                        SubjectName = se.AssignedSubject.Subject.Name,
                        FacultyName = se.AssignedSubject.Faculty.Name,
                        EnrollmentDate = se.EnrolledAt
                    })
                    .ToListAsync(),

                // Get all CSEDS faculty (from Faculty_CSEDS table)
                DepartmentFaculty = await csedsContext.Faculties
                    .OrderBy(f => f.Name)
                    .ToListAsync(),

                // Get all CSEDS subjects (from Subjects_CSEDS table)
                DepartmentSubjects = await csedsContext.Subjects
                    .OrderBy(s => s.Year)
                    .ThenBy(s => s.Name)
                    .ToListAsync(),

                // Get subject-faculty mappings (from CSEDS tables)
                SubjectFacultyMappings = await GetSubjectFacultyMappingsFromDynamicTables(csedsContext)
            };

            Console.WriteLine("CSEDSDashboard loaded successfully from CSEDS-specific tables!");
            return View(viewModel);
        }

        /// <summary>
        /// Get subject-faculty mappings from CSEDS-specific tables
        /// </summary>
        private async Task<List<SubjectFacultyMappingDto>> GetSubjectFacultyMappingsFromDynamicTables(DepartmentDbContext csedsContext)
        {
            // Get all CSEDS subjects from Subjects_CSEDS table
            var subjects = await csedsContext.Subjects.ToListAsync();

            var result = new List<SubjectFacultyMappingDto>();

            foreach (var s in subjects)
            {
                var assignedFaculty = await csedsContext.AssignedSubjects
                    .Include(a => a.Faculty)
                    .Where(a => a.SubjectId == s.SubjectId)
                    .ToListAsync();

                var enrollmentCount = 0;
                var facultyInfos = new List<FacultyInfo>();

                foreach (var assignment in assignedFaculty)
                {
                    var enrollments = await csedsContext.StudentEnrollments
                        .CountAsync(se => se.AssignedSubjectId == assignment.AssignedSubjectId);

                    enrollmentCount += enrollments;

                    facultyInfos.Add(new FacultyInfo
                    {
                        FacultyId = assignment.FacultyId,
                        Name = assignment.Faculty.Name,
                        Email = assignment.Faculty.Email,
                        AssignedSubjectId = assignment.AssignedSubjectId
                    });
                }

                result.Add(new SubjectFacultyMappingDto
                {
                    SubjectId = s.SubjectId,
                    SubjectName = s.Name,
                    Year = s.Year,
                    Semester = s.Semester ?? "",
                    SemesterStartDate = s.SemesterStartDate,
                    SemesterEndDate = s.SemesterEndDate,
                    AssignedFaculty = facultyInfos,
                    EnrollmentCount = enrollmentCount
                });
            }

            return result.OrderBy(s => s.Year).ThenBy(s => s.SubjectName).ToList();
        }

        /// <summary>
        /// Get live dashboard statistics for AJAX refresh - NOW USING DYNAMIC TABLES
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> GetDashboardStats()
        {
            var department = HttpContext.Session.GetString("AdminDepartment");
            if (!IsCSEDSDepartment(department))
                return Json(new { success = false, message = "Unauthorized" });

            try
            {
                // ? NEW: Use CSEDS-specific tables
                using var csedsContext = _dbFactory.GetContext("CSEDS");

                var studentsCount = await csedsContext.Students.CountAsync();
                var facultyCount = await csedsContext.Faculties.CountAsync();
                var subjectsCount = await csedsContext.Subjects.CountAsync();
                var enrollmentsCount = await csedsContext.StudentEnrollments.CountAsync();

                return Json(new
                {
                    success = true,
                    studentsCount,
                    facultyCount,
                    subjectsCount,
                    enrollmentsCount,
                    timestamp = DateTime.Now
                });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error fetching dashboard stats: {ex.Message}");
                return Json(new { success = false, message = "Error fetching statistics" });
            }
        }

        /// <summary>
        /// Get comprehensive faculty management view
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> ManageCSEDSFaculty()
        {
            var department = HttpContext.Session.GetString("AdminDepartment");
            if (!IsCSEDSDepartment(department))
                return RedirectToAction("Login");

            var viewModel = new FacultyManagementViewModel
            {
                DepartmentFaculty = await GetFacultyWithAssignments(),
                AvailableSubjects = await _context.Subjects
                    .Where(s => s.Department == "CSEDS" || s.Department == "CSE(DS)")
                    .OrderBy(s => s.Year)
                    .ThenBy(s => s.Name)
                    .ToListAsync()
            };

            return View(viewModel);
        }

        /// <summary>
        /// Get subject-faculty assignment management view
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> ManageCSEDSSubjects()
        {
            var department = HttpContext.Session.GetString("AdminDepartment");
            if (!IsCSEDSDepartment(department))
                return RedirectToAction("Login");

            var subjects = await _context.Subjects
                .Where(s => s.Department == "CSEDS" || s.Department == "CSE(DS)")
                .OrderBy(s => s.Year)
                .ThenBy(s => s.Name)
                .ToListAsync();

            return View(subjects);
        }

        /// <summary>
        /// Assign faculty to subject
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> AssignFacultyToSubject([FromBody] FacultySubjectAssignmentRequest request)
        {
            var department = HttpContext.Session.GetString("AdminDepartment");
            if (!IsCSEDSDepartment(department))
                return Unauthorized();

            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            try
            {
                var normalizedDept = DepartmentNormalizer.Normalize("CSE(DS)");

                // Verify subject belongs to CSE(DS) department
                var subject = await _context.Subjects
                    .FirstOrDefaultAsync(s => s.SubjectId == request.SubjectId &&
                                            (s.Department == "CSE(DS)" || s.Department == "CSEDS"));

                if (subject == null)
                    return BadRequest("Subject not found or does not belong to CSE(DS) department");

                // Verify faculty belongs to CSE(DS) department
                var faculty = await _context.Faculties
                    .Where(f => request.FacultyIds.Contains(f.FacultyId) &&
                              (f.Department == "CSE(DS)" || f.Department == "CSEDS"))
                    .ToListAsync();

                if (faculty.Count != request.FacultyIds.Count)
                    return BadRequest("One or more faculty members not found or do not belong to CSE(DS) department");

                // Remove existing assignments for this subject
                var existingAssignments = await _context.AssignedSubjects
                    .Where(a => a.SubjectId == request.SubjectId)
                    .ToListAsync();

                _context.AssignedSubjects.RemoveRange(existingAssignments);

                // Create new assignments
                foreach (var facultyId in request.FacultyIds)
                {
                    var assignedSubject = new AssignedSubject
                    {
                        FacultyId = facultyId,
                        SubjectId = request.SubjectId,
                        Department = normalizedDept,  // Uses normalized format
                        Year = subject.Year,
                        SelectedCount = 0
                    };
                    _context.AssignedSubjects.Add(assignedSubject);
                }

                await _context.SaveChangesAsync();

                await _signalRService.NotifyUserActivity(
                    HttpContext.Session.GetString("AdminEmail") ?? "",
                    "Admin",
                    "Faculty Assignment Updated",
                    $"Faculty assignments updated for subject: {subject.Name}"
                );

                return Ok(new { success = true, message = "Faculty assignments updated successfully" });
            }
            catch (Exception ex)
            {
                return BadRequest(new { success = false, message = $"Error updating assignments: {ex.Message}" });
            }
        }

        /// <summary>
        /// Remove faculty assignment from subject
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> RemoveFacultyAssignment([FromBody] RemoveFacultyAssignmentRequest request)
        {
            var department = HttpContext.Session.GetString("AdminDepartment");
            if (!IsCSEDSDepartment(department))
                return Unauthorized();

            try
            {
                var assignment = await _context.AssignedSubjects
                    .Include(a => a.Subject)
                    .Include(a => a.Faculty)
                    .FirstOrDefaultAsync(a => a.AssignedSubjectId == request.AssignedSubjectId &&
                                           (a.Subject.Department == "CSEDS" || a.Subject.Department == "CSE(DS)"));

                if (assignment == null)
                    return NotFound("Assignment not found");

                // Check if there are active enrollments
                var hasEnrollments = await _context.StudentEnrollments
                    .AnyAsync(se => se.AssignedSubjectId == request.AssignedSubjectId);

                if (hasEnrollments)
                    return BadRequest(new { success = false, message = "Cannot remove assignment with active student enrollments" });

                _context.AssignedSubjects.Remove(assignment);
                await _context.SaveChangesAsync();

                await _signalRService.NotifyUserActivity(
                    HttpContext.Session.GetString("AdminEmail") ?? "",
                    "Admin",
                    "Faculty Assignment Removed",
                    $"Faculty {assignment.Faculty.Name} unassigned from subject: {assignment.Subject.Name}"
                );

                return Ok(new { success = true, message = "Faculty assignment removed successfully" });
            }
            catch (Exception ex)
            {
                return BadRequest(new { success = false, message = $"Error removing assignment: {ex.Message}" });
            }
        }

        /// <summary>
        /// Get all faculty in department with their assignments
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> GetDepartmentFaculty()
        {
            var department = HttpContext.Session.GetString("AdminDepartment");
            if (!IsCSEDSDepartment(department))
                return Unauthorized();

            var faculty = await GetFacultyWithAssignments();
            return Json(new { success = true, data = faculty });
        }

        /// <summary>
        /// Get all subjects in department with their assignments
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> GetDepartmentSubjects()
        {
            var department = HttpContext.Session.GetString("AdminDepartment");
            if (!IsCSEDSDepartment(department))
                return Unauthorized();

            var subjects = await GetSubjectsWithAssignments();
            return Json(new { success = true, data = subjects });
        }

        /// <summary>
        /// Get available faculty for a specific subject
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> GetAvailableFacultyForSubject(int subjectId)
        {
            var department = HttpContext.Session.GetString("AdminDepartment");
            if (!IsCSEDSDepartment(department))
                return Unauthorized();

            // Get all CSEDS faculty
            var allFaculty = await _context.Faculties
                .Where(f => f.Department == "CSEDS" || f.Department == "CSE(DS)")
                .Select(f => new { f.FacultyId, f.Name, f.Email })
                .ToListAsync();

            // Get currently assigned faculty for this subject
            var assignedFaculty = await _context.AssignedSubjects
                .Where(a => a.SubjectId == subjectId)
                .Select(a => a.FacultyId)
                .ToListAsync();

            var result = allFaculty.Select(f => new
            {
                f.FacultyId,
                f.Name,
                f.Email,
                IsAssigned = assignedFaculty.Contains(f.FacultyId)
            }).ToList();

            return Json(new { success = true, data = result });
        }

        /// <summary>
        /// Helper method to get faculty with their assignments
        /// </summary>
        private async Task<List<FacultyDetailDto>> GetFacultyWithAssignments()
        {
            // First get all CSEDS faculty
            var faculty = await _context.Faculties
                .Where(f => f.Department == "CSEDS" || f.Department == "CSE(DS)")
                .ToListAsync();

            var result = new List<FacultyDetailDto>();

            foreach (var f in faculty)
            {
                var assignedSubjects = await _context.AssignedSubjects
                    .Include(a => a.Subject)
                    .Where(a => a.FacultyId == f.FacultyId &&
                              (a.Subject.Department == "CSEDS" || a.Subject.Department == "CSE(DS)"))
                    .ToListAsync();

                var enrollmentCount = 0;
                var subjectInfos = new List<AssignedSubjectInfo>();

                foreach (var assignment in assignedSubjects)
                {
                    var enrollments = await _context.StudentEnrollments
                        .CountAsync(se => se.AssignedSubjectId == assignment.AssignedSubjectId);

                    enrollmentCount += enrollments;

                    subjectInfos.Add(new AssignedSubjectInfo
                    {
                        AssignedSubjectId = assignment.AssignedSubjectId,
                        SubjectId = assignment.SubjectId,
                        SubjectName = assignment.Subject.Name,
                        Year = assignment.Subject.Year,
                        Semester = assignment.Subject.Semester ?? "",
                        EnrollmentCount = enrollments
                    });
                }

                result.Add(new FacultyDetailDto
                {
                    FacultyId = f.FacultyId,
                    Name = f.Name,
                    Email = f.Email,
                    Department = f.Department,
                    AssignedSubjects = subjectInfos,
                    TotalEnrollments = enrollmentCount
                });
            }

            return result.OrderBy(f => f.Name).ToList();
        }

        /// <summary>
        /// Helper method to get subjects with their assignments
        /// </summary>
        private async Task<List<SubjectDetailDto>> GetSubjectsWithAssignments()
        {
            var normalizedDept = DepartmentNormalizer.Normalize("CSE(DS)");
            // First get all CSEDS subjects
            var subjects = await _context.Subjects.Where(s => s.Department == normalizedDept)
                .ToListAsync();

            var result = new List<SubjectDetailDto>();

            foreach (var s in subjects)
            {
                var assignedFaculty = await _context.AssignedSubjects
                    .Include(a => a.Faculty)
                    .Where(a => a.SubjectId == s.SubjectId &&
                              (a.Faculty.Department == "CSE(DS)" || a.Faculty.Department == "CSEDS"))
                    .ToListAsync();

                var totalEnrollments = 0;
                var facultyInfos = new List<FacultyInfo>();

                foreach (var assignment in assignedFaculty)
                {
                    var enrollments = await _context.StudentEnrollments
                        .CountAsync(se => se.AssignedSubjectId == assignment.AssignedSubjectId);

                    totalEnrollments += enrollments;

                    facultyInfos.Add(new FacultyInfo
                    {
                        FacultyId = assignment.FacultyId,
                        Name = assignment.Faculty.Name,
                        Email = assignment.Faculty.Email,
                        AssignedSubjectId = assignment.AssignedSubjectId
                    });
                }

                result.Add(new SubjectDetailDto
                {
                    SubjectId = s.SubjectId,
                    Name = s.Name,
                    Department = s.Department,
                    Year = s.Year,
                    Semester = s.Semester ?? "",
                    SemesterStartDate = s.SemesterStartDate,
                    SemesterEndDate = s.SemesterEndDate,
                    AssignedFaculty = facultyInfos,
                    TotalEnrollments = totalEnrollments,
                    IsActive = s.SemesterEndDate == null || s.SemesterEndDate >= DateTime.Now
                });
            }

            return result.OrderBy(s => s.Year).ThenBy(s => s.Name).ToList();
        }

        /// <summary>
        /// Helper method to get subject-faculty mappings
        /// </summary>
        private async Task<List<SubjectFacultyMappingDto>> GetSubjectFacultyMappings()
        {
            var normalizedDept = DepartmentNormalizer.Normalize("CSE(DS)");
            // First get all CSEDS subjects
            var subjects = await _context.Subjects.Where(s => s.Department == normalizedDept)
                .ToListAsync();

            var result = new List<SubjectFacultyMappingDto>();

            foreach (var s in subjects)
            {
                var assignedFaculty = await _context.AssignedSubjects
                    .Include(a => a.Faculty)
                    .Where(a => a.SubjectId == s.SubjectId &&
                              (a.Faculty.Department == "CSE(DS)" || a.Faculty.Department == "CSEDS"))
                    .ToListAsync();

                var enrollmentCount = 0;
                var facultyInfos = new List<FacultyInfo>();

                foreach (var assignment in assignedFaculty)
                {
                    var enrollments = await _context.StudentEnrollments
                        .CountAsync(se => se.AssignedSubjectId == assignment.AssignedSubjectId);

                    enrollmentCount += enrollments;

                    facultyInfos.Add(new FacultyInfo
                    {
                        FacultyId = assignment.FacultyId,
                        Name = assignment.Faculty.Name,
                        Email = assignment.Faculty.Email,
                        AssignedSubjectId = assignment.AssignedSubjectId
                    });
                }

                result.Add(new SubjectFacultyMappingDto
                {
                    SubjectId = s.SubjectId,
                    SubjectName = s.Name,
                    Year = s.Year,
                    Semester = s.Semester ?? "",
                    SemesterStartDate = s.SemesterStartDate,
                    SemesterEndDate = s.SemesterEndDate,
                    AssignedFaculty = facultyInfos,
                    EnrollmentCount = enrollmentCount
                });
            }

            return result.OrderBy(s => s.Year).ThenBy(s => s.SubjectName).ToList();
        }

        // ========================================
        // DYNAMIC HELPER METHODS (All Departments)
        // ========================================

        /// <summary>
        /// Get faculty with their assignments for any department (dynamic)
        /// </summary>
        private async Task<List<FacultyDetailDto>> GetFacultyWithAssignmentsDynamic(string departmentCode)
        {
            var faculty = await _context.Faculties
                .Where(f => f.Department == departmentCode)
                .ToListAsync();

            var result = new List<FacultyDetailDto>();

            foreach (var f in faculty)
            {
                var assignedSubjects = await _context.AssignedSubjects
                    .Include(a => a.Subject)
                    .Where(a => a.FacultyId == f.FacultyId && a.Subject.Department == departmentCode)
                    .ToListAsync();

                var enrollmentCount = 0;
                var subjectInfos = new List<AssignedSubjectInfo>();

                foreach (var assignment in assignedSubjects)
                {
                    var enrollments = await _context.StudentEnrollments
                        .CountAsync(se => se.AssignedSubjectId == assignment.AssignedSubjectId);

                    enrollmentCount += enrollments;

                    subjectInfos.Add(new AssignedSubjectInfo
                    {
                        AssignedSubjectId = assignment.AssignedSubjectId,
                        SubjectId = assignment.SubjectId,
                        SubjectName = assignment.Subject.Name,
                        Year = assignment.Subject.Year,
                        Semester = assignment.Subject.Semester ?? "",
                        EnrollmentCount = enrollments
                    });
                }

                result.Add(new FacultyDetailDto
                {
                    FacultyId = f.FacultyId,
                    Name = f.Name,
                    Email = f.Email,
                    Department = f.Department,
                    AssignedSubjects = subjectInfos,
                    TotalEnrollments = enrollmentCount
                });
            }

            return result.OrderBy(f => f.Name).ToList();
        }

        /// <summary>
        /// Get subjects with their assignments for any department (dynamic)
        /// </summary>
        private async Task<List<SubjectDetailDto>> GetSubjectsWithAssignmentsDynamic(string departmentCode)
        {
            var subjects = await _context.Subjects
                .Where(s => s.Department == departmentCode)
                .ToListAsync();

            var result = new List<SubjectDetailDto>();

            foreach (var s in subjects)
            {
                var assignedFaculty = await _context.AssignedSubjects
                    .Include(a => a.Faculty)
                    .Where(a => a.SubjectId == s.SubjectId && a.Faculty.Department == departmentCode)
                    .ToListAsync();

                var totalEnrollments = 0;
                var facultyInfos = new List<FacultyInfo>();

                foreach (var assignment in assignedFaculty)
                {
                    var enrollments = await _context.StudentEnrollments
                        .CountAsync(se => se.AssignedSubjectId == assignment.AssignedSubjectId);

                    totalEnrollments += enrollments;

                    facultyInfos.Add(new FacultyInfo
                    {
                        FacultyId = assignment.FacultyId,
                        Name = assignment.Faculty.Name,
                        Email = assignment.Faculty.Email,
                        AssignedSubjectId = assignment.AssignedSubjectId
                    });
                }

                result.Add(new SubjectDetailDto
                {
                    SubjectId = s.SubjectId,
                    Name = s.Name,
                    Department = s.Department,
                    Year = s.Year,
                    Semester = s.Semester ?? "",
                    SemesterStartDate = s.SemesterStartDate,
                    SemesterEndDate = s.SemesterEndDate,
                    AssignedFaculty = facultyInfos,
                    TotalEnrollments = totalEnrollments,
                    IsActive = s.SemesterEndDate == null || s.SemesterEndDate >= DateTime.Now
                });
            }

            return result.OrderBy(s => s.Year).ThenBy(s => s.Name).ToList();
        }

        /// <summary>
        /// Get subject-faculty mappings for any department (dynamic)
        /// </summary>
        private async Task<List<SubjectFacultyMappingDto>> GetSubjectFacultyMappingsDynamic(string departmentCode)
        {
            var subjects = await _context.Subjects
                .Where(s => s.Department == departmentCode)
                .ToListAsync();

            var result = new List<SubjectFacultyMappingDto>();

            foreach (var s in subjects)
            {
                var assignedFaculty = await _context.AssignedSubjects
                    .Include(a => a.Faculty)
                    .Where(a => a.SubjectId == s.SubjectId && a.Faculty.Department == departmentCode)
                    .ToListAsync();

                var enrollmentCount = 0;
                var facultyInfos = new List<FacultyInfo>();

                foreach (var assignment in assignedFaculty)
                {
                    var enrollments = await _context.StudentEnrollments
                        .CountAsync(se => se.AssignedSubjectId == assignment.AssignedSubjectId);

                    enrollmentCount += enrollments;

                    facultyInfos.Add(new FacultyInfo
                    {
                        FacultyId = assignment.FacultyId,
                        Name = assignment.Faculty.Name,
                        Email = assignment.Faculty.Email,
                        AssignedSubjectId = assignment.AssignedSubjectId
                    });
                }

                result.Add(new SubjectFacultyMappingDto
                {
                    SubjectId = s.SubjectId,
                    SubjectName = s.Name,
                    Year = s.Year,
                    Semester = s.Semester ?? "",
                    SemesterStartDate = s.SemesterStartDate,
                    SemesterEndDate = s.SemesterEndDate,
                    AssignedFaculty = facultyInfos,
                    EnrollmentCount = enrollmentCount
                });
            }

            return result.OrderBy(s => s.Year).ThenBy(s => s.SubjectName).ToList();
        }

        /// <summary>
        /// Get CSEDS department system information via AJAX
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> CSEDSSystemInfo()
        {
            var adminId = HttpContext.Session.GetInt32("AdminId");
            var department = HttpContext.Session.GetString("AdminDepartment");

            if (adminId == null || !IsCSEDSDepartment(department))
                return Unauthorized();

            var systemInfo = new
            {
                DatabaseStats = new
                {
                    StudentsCount = await _context.Students
                        .Where(s => s.Department == "CSEDS" || s.Department == "CSE(DS)")
                        .CountAsync(),
                    FacultiesCount = await _context.Faculties
                        .Where(f => f.Department == "CSEDS" || f.Department == "CSE(DS)")
                        .CountAsync(),
                    SubjectsCount = await _context.Subjects
                        .Where(s => s.Department == "CSEDS" || s.Department == "CSE(DS)")
                        .CountAsync(),
                    EnrollmentsCount = await _context.StudentEnrollments
                        .Include(se => se.Student)
                        .Where(se => se.Student.Department == "CSEDS" || se.Student.Department == "CSE(DS)")
                        .CountAsync()
                },
                RecentActivity = new
                {
                    RecentStudents = await _context.Students
                        .Where(s => s.Department == "CSEDS" || s.Department == "CSE(DS)")
                        .OrderByDescending(s => s.Id)
                        .Take(5)
                        .Select(s => new { s.FullName, s.Email, s.Department, s.Year })
                        .ToListAsync(),
                    RecentEnrollments = await _context.StudentEnrollments
                        .Include(se => se.Student)
                        .Include(se => se.AssignedSubject)
                            .ThenInclude(a => a.Subject)
                        .Include(se => se.AssignedSubject)
                            .ThenInclude(a => a.Faculty)
                        .Where(se => se.Student.Department == "CSEDS" || se.Student.Department == "CSE(DS)")
                        .OrderByDescending(se => se.EnrolledAt)
                        .Take(10)
                        .Select(se => new
                        {
                            StudentName = se.Student.FullName,
                            SubjectName = se.AssignedSubject.Subject.Name,
                            FacultyName = se.AssignedSubject.Faculty.Name
                        })
                        .ToListAsync()
                }
            };

            return Json(systemInfo);
        }

        [HttpPost]
        public async Task<IActionResult> AddCSEDSFaculty([FromBody] CSEDSFacultyViewModel model)
        {
            var department = HttpContext.Session.GetString("AdminDepartment");
            if (!IsCSEDSDepartment(department))
                return Unauthorized();

            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            // ? NEW: Use CSEDS-specific tables
            using var csedsContext = _dbFactory.GetContext("CSEDS");

            var existingFaculty = await csedsContext.Faculties.FirstOrDefaultAsync(f => f.Email == model.Email);
            if (existingFaculty != null)
                return BadRequest("Faculty with this email already exists");

            var faculty = new Faculty
            {
                Name = model.Name,
                Email = model.Email,
                Password = model.Password,
                Department = "CSEDS"
            };

            csedsContext.Faculties.Add(faculty);
            await csedsContext.SaveChangesAsync();

            if (model.SelectedSubjectIds.Any())
            {
                foreach (var subjectId in model.SelectedSubjectIds)
                {
                    var assignedSubject = new AssignedSubject
                    {
                        FacultyId = faculty.FacultyId,
                        SubjectId = subjectId,
                        Department = "CSEDS",
                        Year = 1,
                        SelectedCount = 0
                    };
                    csedsContext.AssignedSubjects.Add(assignedSubject);
                }
                await csedsContext.SaveChangesAsync();
            }

            await _signalRService.NotifyUserActivity(HttpContext.Session.GetString("AdminEmail") ?? "", "Admin", "Faculty Added", $"New CSE(DS) faculty member {faculty.Name} added to the system");

            // Broadcast dashboard stats update
            await BroadcastDashboardUpdate($"Faculty '{faculty.Name}' added");

            return Ok(new { success = true, message = "Faculty added successfully" });
        }

        [HttpPost]
        public async Task<IActionResult> UpdateCSEDSFaculty([FromBody] CSEDSFacultyViewModel model)
        {
            var department = HttpContext.Session.GetString("AdminDepartment");
            if (!IsCSEDSDepartment(department))
                return Unauthorized();

            // Log what we received
            Console.WriteLine($"[UPDATE] Received model - FacultyId: {model.FacultyId}, Name: '{model.Name}', Email: '{model.Email}', Password: '{model.Password}', Department: '{model.Department}'");

            if (!ModelState.IsValid)
            {
                // Get validation errors
                var errors = ModelState
                    .Where(x => x.Value.Errors.Count > 0)
                    .Select(x => new { Field = x.Key, Errors = x.Value.Errors.Select(e => e.ErrorMessage).ToList() })
                    .ToList();

                Console.WriteLine($"[UPDATE] Model validation failed:");
                foreach (var error in errors)
                {
                    Console.WriteLine($"  - {error.Field}: {string.Join(", ", error.Errors)}");
                }

                var errorMessage = string.Join("; ", errors.SelectMany(e => e.Errors));
                return BadRequest(new { success = false, message = $"Validation errors: {errorMessage}" });
            }

            try
            {
                Console.WriteLine($"[UPDATE] Starting update for FacultyId: {model.FacultyId}");

                // ? NEW: Use CSEDS-specific tables
                using var csedsContext = _dbFactory.GetContext("CSEDS");

                // Query without tracking to avoid caching issues
                var faculty = await csedsContext.Faculties
                    .AsNoTracking()
                    .FirstOrDefaultAsync(f => f.FacultyId == model.FacultyId);

                if (faculty == null)
                {
                    Console.WriteLine($"[UPDATE] Faculty not found: {model.FacultyId}");
                    return NotFound(new { success = false, message = "Faculty not found" });
                }

                Console.WriteLine($"[UPDATE] Found faculty - Current Name: {faculty.Name}, Current Email: {faculty.Email}");

                // Check if email is being changed to an existing email
                if (faculty.Email != model.Email)
                {
                    var emailExists = await csedsContext.Faculties
                        .AnyAsync(f => f.Email == model.Email && f.FacultyId != model.FacultyId);
                    
                    if (emailExists)
                    {
                        Console.WriteLine($"[UPDATE] Email already exists: {model.Email}");
                        return BadRequest(new { success = false, message = "Email already exists for another faculty" });
                    }
                }

                // Create a new instance with updated values
                var updatedFaculty = new Faculty
                {
                    FacultyId = faculty.FacultyId,
                    Name = model.Name,
                    Email = model.Email,
                    Password = !string.IsNullOrEmpty(model.Password) ? model.Password : faculty.Password,
                    Department = faculty.Department
                };

                Console.WriteLine($"[UPDATE] Updating faculty with new values...");

                // Use Update method to ensure EF tracks the entity
                csedsContext.Faculties.Update(updatedFaculty);

                // Save changes
                var changeCount = await csedsContext.SaveChangesAsync();
                Console.WriteLine($"[UPDATE] SaveChangesAsync returned: {changeCount} changes");

                if (changeCount == 0)
                {
                    Console.WriteLine("[UPDATE] WARNING: No changes were saved to the database!");
                    return BadRequest(new { success = false, message = "No changes were saved. Please try again." });
                }

                await _signalRService.NotifyUserActivity(
                    HttpContext.Session.GetString("AdminEmail") ?? "", 
                    "Admin", 
                    "Faculty Updated", 
                    $"CSE(DS) faculty member {updatedFaculty.Name} information updated"
                );

                Console.WriteLine("[UPDATE] Faculty updated successfully!");
                return Ok(new { success = true, message = "Faculty updated successfully" });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[UPDATE] Error: {ex.Message}");
                Console.WriteLine($"[UPDATE] Stack Trace: {ex.StackTrace}");
                return BadRequest(new { success = false, message = $"Error updating faculty: {ex.Message}" });
            }
        }

        [HttpPost]
        public async Task<IActionResult> DeleteCSEDSFaculty([FromBody] DeleteFacultyRequest request)
        {
            try
            {
                Console.WriteLine($"[DELETE] Starting delete for FacultyId: {request?.FacultyId}");
                
                var department = HttpContext.Session.GetString("AdminDepartment");
                if (!IsCSEDSDepartment(department))
                {
                    Console.WriteLine("[DELETE] Unauthorized - Not CSEDS department");
                    return Unauthorized(new { success = false, message = "Unauthorized access" });
                }

                if (request == null || request.FacultyId <= 0)
                {
                    Console.WriteLine("[DELETE] Invalid request - FacultyId is null or invalid");
                    return BadRequest(new { success = false, message = "Invalid faculty ID" });
                }

                var facultyId = request.FacultyId;
                Console.WriteLine($"[DELETE] Looking for faculty with ID: {facultyId}");
                
                // ? NEW: Use CSEDS-specific tables
                using var csedsContext = _dbFactory.GetContext("CSEDS");

                var faculty = await csedsContext.Faculties
                    .Include(f => f.AssignedSubjects)
                        .ThenInclude(a => a.Enrollments)
                    .FirstOrDefaultAsync(f => f.FacultyId == facultyId);

                if (faculty == null)
                {
                    Console.WriteLine($"[DELETE] Faculty not found with ID: {facultyId}");
                    return NotFound(new { success = false, message = "Faculty member not found" });
                }

                Console.WriteLine($"[DELETE] Found faculty: {faculty.Name}");

                var hasEnrollments = faculty.AssignedSubjects?.Any(a => a.Enrollments?.Any() == true) == true;
                if (hasEnrollments)
                {
                    Console.WriteLine("[DELETE] Cannot delete - Faculty has active enrollments");
                    return BadRequest(new { success = false, message = "Cannot delete faculty with active student enrollments" });
                }

                Console.WriteLine($"[DELETE] Removing {faculty.AssignedSubjects?.Count ?? 0} assigned subjects");
                if (faculty.AssignedSubjects != null && faculty.AssignedSubjects.Any())
                    csedsContext.AssignedSubjects.RemoveRange(faculty.AssignedSubjects);

                Console.WriteLine("[DELETE] Removing faculty from database");
                csedsContext.Faculties.Remove(faculty);
                await csedsContext.SaveChangesAsync();
                
                Console.WriteLine("[DELETE] Faculty deleted successfully");

                await _signalRService.NotifyUserActivity(
                    HttpContext.Session.GetString("AdminEmail") ?? "", 
                    "Admin", 
                    "Faculty Deleted", 
                    $"CSE(DS) faculty member {faculty.Name} has been deleted from the system"
                );

                // Broadcast dashboard stats update
                await BroadcastDashboardUpdate($"Faculty '{faculty.Name}' deleted");

                return Ok(new { success = true, message = "Faculty deleted successfully" });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[DELETE] Error: {ex.Message}");
                return BadRequest(new { success = false, message = $"Error deleting faculty: {ex.Message}" });
            }
        }

        /// <summary>
        /// Add new CSEDS subject
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> AddCSEDSSubject([FromBody] SubjectViewModel model)
        {
            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            try
            {
                var normalizedDept = DepartmentNormalizer.Normalize("CSE(DS)");

                // Check for existing subject
                var existingSubject = await _context.Subjects
                    .FirstOrDefaultAsync(s => s.Name == model.Name && s.Department == normalizedDept);

                if (existingSubject != null)
                    return BadRequest("Subject already exists in the CSE(DS) department");

                var subject = new Subject
                {
                    Name = model.Name,
                    Department = normalizedDept,
                    Year = model.Year,
                    Semester = model.Semester,
                    SemesterStartDate = model.SemesterStartDate,
                    SemesterEndDate = model.SemesterEndDate
                };

                _context.Subjects.Add(subject);
                await _context.SaveChangesAsync();

                return Ok(new { success = true, message = "Subject added successfully" });
            }
            catch (Exception ex)
            {
                return BadRequest(new { success = false, message = $"Error adding subject: {ex.Message}" });
            }
        }

        /// <summary>
        /// Request model for faculty-subject assignment
        /// </summary>
        public class FacultySubjectAssignmentRequest
        {
            public int SubjectId { get; set; }
            public List<int> FacultyIds { get; set; } = new List<int>();
        }

        /// <summary>
        /// Request model for removing faculty assignment
        /// </summary>
        public class RemoveFacultyAssignmentRequest
        {
            public int AssignedSubjectId { get; set; }
        }

        /// <summary>
        /// Request model for deleting subject
        /// </summary>
        public class DeleteSubjectRequest
        {
            public int SubjectId { get; set; }
        }

        /// <summary>
        /// Request model for deleting faculty
        /// </summary>
        public class DeleteFacultyRequest
        {
            public int FacultyId { get; set; }
        }

        /// <summary>
        /// Request model for deleting student
        /// </summary>
        public class DeleteStudentRequest
        {
            public string StudentId { get; set; }
        }

        /// <summary>
        /// Admin Profile - Generic entry point that redirects to department-specific profile
        /// </summary>
        [HttpGet]
        public IActionResult Profile()
        {
            var adminId = HttpContext.Session.GetInt32("AdminId");
            var department = HttpContext.Session.GetString("AdminDepartment");

            if (adminId == null)
            {
                TempData["ErrorMessage"] = "Please login to access your profile.";
                return RedirectToAction("Login");
            }

            // Redirect to department-specific profile
            if (IsCSEDSDepartment(department))
            {
                return RedirectToAction("CSEDSProfile");
            }
            else
            {
                return RedirectToAction("DynamicProfile", new { department = department });
            }
        }

        /// <summary>
        /// CSEDS Admin Profile Page
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> CSEDSProfile()
        {
            var adminId = HttpContext.Session.GetInt32("AdminId");
            var department = HttpContext.Session.GetString("AdminDepartment");

            if (adminId == null)
            {
                TempData["ErrorMessage"] = "Please login to access your profile.";
                return RedirectToAction("Login");
            }

            if (!IsCSEDSDepartment(department))
            {
                TempData["ErrorMessage"] = "Access denied. This profile is for CSEDS department only.";
                return RedirectToAction("Login");
            }

            var admin = await _context.Admins.FindAsync(adminId.Value);
            if (admin == null)
            {
                TempData["ErrorMessage"] = "Admin account not found.";
                return RedirectToAction("Login");
            }

            var model = new AdminProfileViewModel
            {
                AdminId = admin.AdminId,
                Email = admin.Email,
                Department = admin.Department,
                CreatedDate = admin.CreatedDate,
                LastLogin = admin.LastLogin
            };

            return View(model);
        }

        /// <summary>
        /// Dynamic Admin Profile Page - For all non-CSEDS departments
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> DynamicProfile(string department)
        {
            var adminId = HttpContext.Session.GetInt32("AdminId");
            var sessionDepartment = HttpContext.Session.GetString("AdminDepartment");

            if (adminId == null)
            {
                TempData["ErrorMessage"] = "Please login to access your profile.";
                return RedirectToAction("Login");
            }

            // Verify department matches session
            if (string.IsNullOrEmpty(department) || department != sessionDepartment)
            {
                TempData["ErrorMessage"] = "Invalid department access.";
                return RedirectToAction("DynamicDashboard", new { department = sessionDepartment });
            }

            var admin = await _context.Admins.FindAsync(adminId.Value);
            if (admin == null)
            {
                TempData["ErrorMessage"] = "Admin account not found.";
                return RedirectToAction("Login");
            }

            var model = new AdminProfileViewModel
            {
                AdminId = admin.AdminId,
                Email = admin.Email,
                Department = admin.Department,
                CreatedDate = admin.CreatedDate,
                LastLogin = admin.LastLogin
            };

            ViewBag.DepartmentCode = department;
            ViewBag.DepartmentName = admin.Department;

            return View(model);
        }

        /// <summary>
        /// Update CSEDS Admin Profile
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> UpdateProfile(AdminProfileViewModel model)
        {
            var adminId = HttpContext.Session.GetInt32("AdminId");
            var department = HttpContext.Session.GetString("AdminDepartment");

            if (adminId == null)
            {
                TempData["ErrorMessage"] = "Please login to update your profile.";
                return RedirectToAction("Login");
            }

            if (!ModelState.IsValid)
            {
                return View("CSEDSProfile", model);
            }

            try
            {
                var admin = await _context.Admins.FindAsync(adminId.Value);
                if (admin == null)
                {
                    TempData["ErrorMessage"] = "Admin account not found.";
                    return RedirectToAction("Login");
                }

                // Check if email is already used by another admin
                var existingAdmin = await _context.Admins
                    .FirstOrDefaultAsync(a => a.Email == model.Email && a.AdminId != adminId.Value);

                if (existingAdmin != null)
                {
                    ModelState.AddModelError("Email", "This email is already registered to another admin");
                    return View("CSEDSProfile", model);
                }

                // Update admin information
                admin.Email = model.Email;
                await _context.SaveChangesAsync();

                // Update session with new email
                HttpContext.Session.SetString("AdminEmail", admin.Email);
                await HttpContext.Session.CommitAsync();

                await _signalRService.NotifyUserActivity(
                    admin.Email,
                    "Admin",
                    "Profile Updated",
                    $"{admin.Department} admin updated their profile information"
                );

                TempData["SuccessMessage"] = "Profile updated successfully!";
                return RedirectToAction("CSEDSProfile");
            }
            catch (Exception ex)
            {
                TempData["ErrorMessage"] = $"Error updating profile: {ex.Message}";
                return View("CSEDSProfile", model);
            }
        }

        /// <summary>
        /// Update Dynamic Admin Profile
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> UpdateDynamicProfile(AdminProfileViewModel model, string department)
        {
            var adminId = HttpContext.Session.GetInt32("AdminId");
            var sessionDepartment = HttpContext.Session.GetString("AdminDepartment");

            if (adminId == null)
            {
                TempData["ErrorMessage"] = "Please login to update your profile.";
                return RedirectToAction("Login");
            }

            if (!ModelState.IsValid)
            {
                ViewBag.DepartmentCode = department;
                ViewBag.DepartmentName = sessionDepartment;
                return View("DynamicProfile", model);
            }

            try
            {
                var admin = await _context.Admins.FindAsync(adminId.Value);
                if (admin == null)
                {
                    TempData["ErrorMessage"] = "Admin account not found.";
                    return RedirectToAction("Login");
                }

                // Check if email is already used by another admin
                var existingAdmin = await _context.Admins
                    .FirstOrDefaultAsync(a => a.Email == model.Email && a.AdminId != adminId.Value);

                if (existingAdmin != null)
                {
                    ModelState.AddModelError("Email", "This email is already registered to another admin");
                    ViewBag.DepartmentCode = department;
                    ViewBag.DepartmentName = sessionDepartment;
                    return View("DynamicProfile", model);
                }

                // Update admin information
                admin.Email = model.Email;
                await _context.SaveChangesAsync();

                // Update session with new email
                HttpContext.Session.SetString("AdminEmail", admin.Email);
                await HttpContext.Session.CommitAsync();

                await _signalRService.NotifyUserActivity(
                    admin.Email,
                    "Admin",
                    "Profile Updated",
                    $"{admin.Department} admin updated their profile information"
                );

                TempData["SuccessMessage"] = "Profile updated successfully!";
                return RedirectToAction("DynamicProfile", new { department = department });
            }
            catch (Exception ex)
            {
                TempData["ErrorMessage"] = $"Error updating profile: {ex.Message}";
                ViewBag.DepartmentCode = department;
                ViewBag.DepartmentName = sessionDepartment;
                return View("DynamicProfile", model);
            }
        }

        /// <summary>
        /// Change Admin Password
        /// </summary>
        [HttpPost]
        public async Task<IActionResult> ChangeAdminPassword([FromBody] AdminChangePasswordViewModel model)
        {
            var adminId = HttpContext.Session.GetInt32("AdminId");

            if (adminId == null)
            {
                return Json(new { success = false, message = "Please login to change password." });
            }

            try
            {
                var admin = await _context.Admins.FindAsync(adminId.Value);
                if (admin == null)
                {
                    return Json(new { success = false, message = "Admin account not found." });
                }

                // Verify current password
                if (admin.Password != model.CurrentPassword)
                {
                    return Json(new { success = false, message = "Current password is incorrect." });
                }

                // Validate new password
                if (model.NewPassword.Length < 6)
                {
                    return Json(new { success = false, message = "Password must be at least 6 characters long." });
                }

                // Update password
                admin.Password = model.NewPassword;
                await _context.SaveChangesAsync();

                await _signalRService.NotifyUserActivity(
                    admin.Email,
                    "Admin",
                    "Password Changed",
                    $"{admin.Department} admin changed their password"
                );

                return Json(new { success = true, message = "Password changed successfully!" });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = $"Error changing password: {ex.Message}" });
            }
        }

        /// <summary>
        /// Admin Logout
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> Logout()
        {
            var adminEmail = HttpContext.Session.GetString("AdminEmail");
            var department = HttpContext.Session.GetString("AdminDepartment");

            if (!string.IsNullOrEmpty(adminEmail))
            {
                await _signalRService.NotifyUserActivity(
                    adminEmail,
                    "Admin",
                    "Logged Out",
                    $"{department} department administrator logged out of the system"
                );
            }

            HttpContext.Session.Clear();
            return RedirectToAction("Login");
        }
    }
}
































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































